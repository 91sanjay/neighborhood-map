!function(){"use strict";var a={markerLocations:[{id:1,title:"Empire State Building",coordinates:{lat:40.748441,lng:-73.985664}},{id:2,title:"Times Sqaure",coordinates:{lat:40.759011,lng:-73.984472}},{id:3,title:"Madison Sqaure Garden",coordinates:{lat:40.750506,lng:-73.993394}},{id:4,title:"Central Park",coordinates:{lat:40.782865,lng:-73.965355}},{id:5,title:"New York Stock Exchange",coordinates:{lat:40.706876,lng:-74.011265}}]},b=function(a){this.id=a.id,this.title=a.title,this.coordinates=a.coordinates,this.placeIdUrl="https://api.flickr.com/services/rest/?method=flickr.places.findByLatLon&api_key=360da6373d34f0076c66dedc9bf6270d&lat="+a.coordinates.lat+"&lon="+a.coordinates.lng+"&format=json&nojsoncallback=1",this.flickrUrl="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=360da6373d34f0076c66dedc9bf6270d&text="+a.title+"&lat="+a.coordinates.lat+"&lon="+a.coordinates.lng+"[placeid]&per_page=10&format=json&nojsoncallback=1"},c=function(){var d,c=this;this.markersArray=ko.observableArray(),this.markerObjects=[],this.filterCriteria=ko.observable("");var e=function(){a.markerLocations.forEach(function(a){c.markerObjects.push(new b(a))}),d=new google.maps.Map(document.getElementById("map"),{center:{lat:40.759011,lng:-73.984472},zoom:12}),google.maps.event.addDomListener(window,"resize",function(){var a=d.getCenter();google.maps.event.trigger(d,"resize"),d.setCenter(a)}),c.placeMarkers(),console.log(infoWindowContent)};this.placeMarkers=function(){this.markerObjects.forEach(function(a){var b=new google.maps.Marker({id:a.id,animation:google.maps.Animation.DROP,position:a.coordinates,map:d,title:a.title,placeIdUrl:a.placeIdUrl,flickrUrl:a.flickrUrl});c.markersArray.push(b)})},e();var f=function(a){return infoWindowContent.replace("[title]",a.title).replace("[gallery]",ajaxLoader)};ko.utils.arrayForEach(this.markersArray(),function(a){function c(){null!==a.getAnimation()?a.setAnimation(null):(a.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.setAnimation(null)},2e3))}function j(){e.open(d,a),g(a),i(a,e)}var b;google.maps.event.addListener(a,"click",function(){d.panTo(a.getPosition()),d.panBy(0,-100)}),a.addListener("click",c),b=f(a);var e=new google.maps.InfoWindow({content:b,maxWidth:300});google.maps.event.addListener(a,"click",j),google.maps.event.addListener(e,"closeclick",function(){h(a)})}),this.selectMarker=function(a){var b=f(a),c=new google.maps.InfoWindow({content:b,maxWidth:300});g(a),d.panTo(a.getPosition()),d.panBy(0,-100),a.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.setAnimation(null)},2e3),google.maps.event.addListener(c,"closeclick",function(){h(a)}),c.open(d,a),i(a,c)};var g=function(a){var b=document.getElementById(a.id);b.className+=" active"},h=function(a){var b=document.getElementById(a.id);b.className="place"},i=function(a,b){j(a.placeIdUrl).done(function(c){console.log("enter");var d;"fail"==c.stat?(console.log("API returned error while retrieving palce if"),d=a.flickrUrl.replace("[placeid]","")):(d=a.flickrUrl.replace("[placeid]","&place_id="+c.places.place[0].place_id),k(d).done(function(c){if("fail"==c.stat)console.log("API returned error while retrieving photos");else{console.log(c.photos.photo.length);var d=l(a.title,c.photos.photo);console.log(d),b.setContent(d)}}))}).fail(function(){console.log("Failed")})},j=function(a){var b=$.Deferred();return $.getJSON(a).then(function(a){a||b.reject(a),b.resolve(a)}),b.promise()},k=function(a){var b=$.Deferred();return $.getJSON(a).then(function(a){a||b.reject(a),b.resolve(a)}),b.promise()},l=function(a,b){for(var c=infoWindowContent.replace("[title]",a),d=[],e=0;3>e;e++){var f=b[e],g=imgUrl.replace("[farmno]",f.farm).replace("[server]",f.server).replace("[id]",f.id).replace("[secret]",f.secret);d.push(g)}var h=galleryTemplate.replace("[img-1-a]",d[0]).replace("[img-1-src]",d[0]).replace("[img-2-a]",d[1]).replace("[img-2-src]",d[1]).replace("[img-3-a]",d[2]).replace("[img-3-src]",d[2]);return c.replace("[gallery]",h)};this.filter=function(){c.filterCriteria()&&""!=c.filterCriteria()||ko.utils.arrayForEach(c.markersArray(),function(a){var b=document.getElementById(a.id);a.setVisible(!0),b.className="place"}),ko.utils.arrayForEach(c.markersArray(),function(a){var b=document.getElementById(a.id),d=a.title.toLowerCase().indexOf(c.filterCriteria().toLowerCase());0>d?(b.className="place hide",a.setVisible(!1)):(b.className="place",a.setVisible(!0))})}};ko.applyBindings(new c)}();