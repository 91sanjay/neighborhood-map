"use strict";function init(){ko.applyBindings(new ViewModel)}var Model={markerLocations:[{id:1,title:"Empire State Building",coordinates:{lat:40.748441,lng:-73.985664}},{id:2,title:"Times Sqaure",coordinates:{lat:40.759011,lng:-73.984472}},{id:3,title:"Madison Sqaure Garden",coordinates:{lat:40.750506,lng:-73.993394}},{id:4,title:"Central Park",coordinates:{lat:40.782865,lng:-73.965355}},{id:5,title:"New York Stock Exchange",coordinates:{lat:40.706876,lng:-74.011265}}]},Marker=function(e){this.id=e.id,this.title=e.title,this.coordinates=e.coordinates,this.placeIdUrl="https://api.flickr.com/services/rest/?method=flickr.places.findByLatLon&api_key=360da6373d34f0076c66dedc9bf6270d&lat="+e.coordinates.lat+"&lon="+e.coordinates.lng+"&format=json&nojsoncallback=1",this.flickrUrl="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=360da6373d34f0076c66dedc9bf6270d&text="+e.title+"&lat="+e.coordinates.lat+"&lon="+e.coordinates.lng+"[placeid]&per_page=10&format=json&nojsoncallback=1"},ViewModel=function(){var e,t=this;this.markersArray=ko.observableArray(),this.markerObjects=[],this.filterCriteria=ko.observable("");var i=function(){Model.markerLocations.forEach(function(e){t.markerObjects.push(new Marker(e))}),e=new google.maps.Map(document.getElementById("map"),{center:{lat:40.759011,lng:-73.984472},zoom:12}),google.maps.event.addDomListener(window,"resize",function(){var t=e.getCenter();google.maps.event.trigger(e,"resize"),e.setCenter(t)}),t.placeMarkers()};this.placeMarkers=function(){this.markerObjects.forEach(function(i){var a=new google.maps.Marker({id:i.id,animation:google.maps.Animation.DROP,position:i.coordinates,map:e,title:i.title,placeIdUrl:i.placeIdUrl,flickrUrl:i.flickrUrl});t.markersArray.push(a)})},i();var a=function(e){return infoWindowContent.replace("[title]",e.title).replace("[gallery]",ajaxLoader)};ko.utils.arrayForEach(this.markersArray(),function(t){function i(){null!==t.getAnimation()?t.setAnimation(null):(t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},2e3))}function l(){s.open(e,t),r(t),n(t,s)}var c;google.maps.event.addListener(t,"click",function(){e.panTo(t.getPosition()),e.panBy(0,-100)}),t.addListener("click",i),c=a(t);var s=new google.maps.InfoWindow({content:c,maxWidth:300});google.maps.event.addListener(t,"click",l),google.maps.event.addListener(s,"closeclick",function(){o(t)})}),this.selectMarker=function(t){var i=a(t),l=new google.maps.InfoWindow({content:i,maxWidth:300});r(t),e.panTo(t.getPosition()),e.panBy(0,-100),t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},2e3),google.maps.event.addListener(l,"closeclick",function(){o(t)}),l.open(e,t),n(t,l)};var r=function(e){var t=document.getElementById(e.id);t.className+=" active"},o=function(e){var t=document.getElementById(e.id);t.className="place"},n=function(e,t){l(e.placeIdUrl).done(function(i){console.log("enter"+i);var a;"fail"==i.stat?(d(placeFailAlert,placeIdFailMsg),a=e.flickrUrl.replace("[placeid]","")):(a=e.flickrUrl.replace("[placeid]","&place_id="+i.places.place[0].place_id),c(a).done(function(i){if("fail"==i.stat)d(flickrFailAlert,flickrFailMsg),console.log("API returned error while retrieving photos");else{console.log(i.photos.photo.length);var a=s(e.title,i.photos.photo);console.log(a),t.setContent(a)}}).fail(function(){d(flickrFailAlert,flickrFailMsg)}))}).fail(function(){d(placeFailAlert,placeIdFailMsg)})},l=function(e){var t=$.Deferred();return $.getJSON(e).done(function(e){e||t.reject(e),t.resolve(e)}).fail(function(e){t.reject(e)}),t.promise()},c=function(e){var t=$.Deferred();return $.getJSON(e).done(function(e){e||t.reject(e),t.resolve(e)}).fail(function(e){t.reject(e)}),t.promise()},s=function(e,t){for(var i=infoWindowContent.replace("[title]",e),a=[],r=0;3>r;r++){var o=t[r],n=imgUrl.replace("[farmno]",o.farm).replace("[server]",o.server).replace("[id]",o.id).replace("[secret]",o.secret);a.push(n)}var l=galleryTemplate.replace("[img-1-a]",a[0]).replace("[img-1-src]",a[0]).replace("[img-2-a]",a[1]).replace("[img-2-src]",a[1]).replace("[img-3-a]",a[2]).replace("[img-3-src]",a[2]);return i.replace("[gallery]",l)};this.filter=function(){t.filterCriteria()&&""!=t.filterCriteria()||ko.utils.arrayForEach(t.markersArray(),function(e){var t=document.getElementById(e.id);e.setVisible(!0),t.className="place"}),ko.utils.arrayForEach(t.markersArray(),function(e){var i=document.getElementById(e.id),a=e.title.toLowerCase().indexOf(t.filterCriteria().toLowerCase());0>a?(i.className="place hide",e.setVisible(!1)):(i.className="place",e.setVisible(!0))})};var d=function(e,t){console.log("called"),console.log(e),document.body.insertAdjacentHTML("afterbegin",e.replace("[error]",t))}};