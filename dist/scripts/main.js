"use strict";function init(){ko.applyBindings(new ViewModel)}var Model={markerLocations:[{id:1,title:"Empire State Building",coordinates:{lat:40.748441,lng:-73.985664}},{id:2,title:"Times Square",coordinates:{lat:40.759011,lng:-73.984472}},{id:3,title:"Madison Square Garden",coordinates:{lat:40.750506,lng:-73.993394}},{id:4,title:"Central Park",coordinates:{lat:40.782865,lng:-73.965355}},{id:5,title:"New York Stock Exchange",coordinates:{lat:40.706876,lng:-74.011265}}]},Marker=function(a){this.id=a.id,this.title=a.title,this.coordinates=a.coordinates,this.placeIdUrl="https://api.flickr.com/services/rest/?method=flickr.places.findByLatLon&api_key=360da6373d34f0076c66dedc9bf6270d&lat="+a.coordinates.lat+"&lon="+a.coordinates.lng+"&format=json&nojsoncallback=1",this.flickrUrl="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=360da6373d34f0076c66dedc9bf6270d&text="+a.title+"&lat="+a.coordinates.lat+"&lon="+a.coordinates.lng+"[placeid]&per_page=10&format=json&nojsoncallback=1"},ViewModel=function(){var b,a=this;this.markersArray=ko.observableArray(),this.markerObjects=[],this.filterCriteria=ko.observable(""),this.infoWindows=ko.observableArray();var c=function(){Model.markerLocations.forEach(function(b){a.markerObjects.push(new Marker(b))}),b=new google.maps.Map(document.getElementById("map"),{center:{lat:40.759011,lng:-73.984472},zoom:12}),google.maps.event.addDomListener(window,"resize",function(){var a=b.getCenter();google.maps.event.trigger(b,"resize"),b.setCenter(a)}),a.placeMarkers()};this.placeMarkers=function(){this.markerObjects.forEach(function(c){var d=new google.maps.Marker({id:c.id,animation:google.maps.Animation.DROP,position:c.coordinates,map:b,title:c.title,placeIdUrl:c.placeIdUrl,flickrUrl:c.flickrUrl});a.markersArray.push(d)})},c();var d=function(a){return infoWindowContent.replace("[title]",a.title).replace("[gallery]",ajaxLoader)};ko.utils.arrayForEach(this.markersArray(),function(c){function j(){null!==c.getAnimation()?c.setAnimation(null):(c.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){c.setAnimation(null)},2e3))}function l(){g(a.infoWindows()),k.open(b,c),a.infoWindows.push(k),e(c),h(c,k)}var i;google.maps.event.addListener(c,"click",function(){b.panTo(c.getPosition()),b.panBy(0,-100)}),c.addListener("click",j),i=d(c);var k=new google.maps.InfoWindow({content:i,maxWidth:300});google.maps.event.addListener(c,"click",l),google.maps.event.addListener(k,"closeclick",function(){f(c)})}),this.selectMarker=function(c){var i=d(c);g(a.infoWindows());var j=new google.maps.InfoWindow({content:i,maxWidth:300});e(c),b.panTo(c.getPosition()),b.panBy(0,-100),c.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){c.setAnimation(null)},2e3),google.maps.event.addListener(j,"closeclick",function(){f(c)}),j.open(b,c),a.infoWindows.push(j),h(c,j)};var e=function(a){for(var b=document.getElementById(a.id),c=document.getElementsByClassName("place"),d=0;d<c.length;d++)c[d].className="place";b.className+=" active"},f=function(a){var b=document.getElementById(a.id);b.className="place"},g=function(a){ko.utils.arrayForEach(a,function(a){a.close()})},h=function(a,b){i(a.placeIdUrl).done(function(c){var d;"fail"==c.stat?(l(placeFailAlert,placeIdFailMsg),d=a.flickrUrl.replace("[placeid]","")):(d=a.flickrUrl.replace("[placeid]","&place_id="+c.places.place[0].place_id),j(d).done(function(c){if("fail"==c.stat)l(flickrFailAlert,flickrFailMsg);else{var d=k(a.title,c.photos.photo);b.setContent(d)}}).fail(function(){l(flickrFailAlert,flickrFailMsg)}))}).fail(function(){l(placeFailAlert,placeIdFailMsg)})},i=function(a){var b=$.Deferred();return $.getJSON(a).done(function(a){a||b.reject(a),b.resolve(a)}).fail(function(a){b.reject(a)}),b.promise()},j=function(a){var b=$.Deferred();return $.getJSON(a).done(function(a){a||b.reject(a),b.resolve(a)}).fail(function(a){b.reject(a)}),b.promise()},k=function(a,b){for(var c=infoWindowContent.replace("[title]",a),d=[],e=0;3>e;e++){var f=b[e],g=imgUrl.replace("[farmno]",f.farm).replace("[server]",f.server).replace("[id]",f.id).replace("[secret]",f.secret);d.push(g)}var h=galleryTemplate.replace("[img-1-a]",d[0]).replace("[img-1-src]",d[0]).replace("[img-2-a]",d[1]).replace("[img-2-src]",d[1]).replace("[img-3-a]",d[2]).replace("[img-3-src]",d[2]);return c.replace("[gallery]",h)};this.filter=function(){a.filterCriteria()&&""!=a.filterCriteria()||ko.utils.arrayForEach(a.markersArray(),function(a){var b=document.getElementById(a.id);a.setVisible(!0),b.className="place"}),ko.utils.arrayForEach(a.markersArray(),function(b){var c=document.getElementById(b.id),d=b.title.toLowerCase().indexOf(a.filterCriteria().toLowerCase());0>d?(c.className="place hide",b.setVisible(!1)):(c.className="place",b.setVisible(!0))})};var l=function(a,b){document.body.insertAdjacentHTML("afterbegin",a.replace("[error]",b))}};